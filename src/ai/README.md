# ИИ Анализ Контента

Модуль ИИ анализа предоставляет интеллектуальные возможности для анализа, категоризации и оценки важности контента из Telegram каналов.

## Компоненты

### AIAnalysisService

Основной сервис для анализа контента с помощью OpenAI API.

**Возможности:**
- Анализ важности сообщений (0-100 баллов)
- Категоризация по 15 предопределенным категориям
- Определение тональности (positive/negative/neutral)
- Извлечение ключевых слов
- Обнаружение спама и рекламы
- Fallback режим при недоступности ИИ

**Пример использования:**
```typescript
import { getAIAnalysisService } from './ai/AIAnalysisService';

const aiService = getAIAnalysisService();
const analysis = await aiService.analyzeContent(
  'Президент подписал важный указ',
  'РБК Новости'
);

console.log(`Важность: ${analysis.importance.score}/100`);
console.log(`Категория: ${analysis.category.category}`);
```

### NewsScoreService

Сервис для комплексной оценки важности новостей на основе множественных факторов.

**Факторы оценки:**
- **ИИ анализ (50%)** - результат от AIAnalysisService
- **Контент (25%)** - длина, ключевые слова, breaking news
- **Источник (15%)** - надежность канала, верификация
- **Актуальность (10%)** - время публикации, срочность

**Классификация:**
- **Critical (85-100)** - экстренные новости
- **High (70-84)** - важные новости
- **Medium (50-69)** - новости средней важности  
- **Low (30-49)** - малозначимые новости
- **Minimal (0-29)** - развлекательный контент

**Пример использования:**
```typescript
import { newsScoreService } from './ai/NewsScoreService';

const score = await newsScoreService.calculateScore(
  content,
  aiAnalysis,
  channelName,
  subscribersCount,
  isVerified,
  mediaType
);

console.log(`Итоговый балл: ${score.finalScore}/100`);
console.log(`Классификация: ${score.classification}`);
```

## Интеграция в Pipeline

### AIProcessorService

Сервис для автоматической обработки сообщений в рамках общего pipeline.

**Возможности:**
- Пакетная обработка необработанных сообщений
- Обработка отдельных сообщений
- Fallback анализ без ИИ
- Статистика обработки
- Настраиваемые параметры обработки

**Автоматическая интеграция:**
ИИ анализ автоматически запускается для всех сообщений, прошедших фильтрацию контента в `TelegramUserbot.handleNewMessage()`.

## Конфигурация

### Переменные окружения

```env
# OpenAI API
OPENAI_API_KEY=your_openai_api_key

# Настройки ИИ (опционально)
AI_MODEL=gpt-3.5-turbo
AI_MAX_TOKENS=1000
AI_TEMPERATURE=0.3
```

### Настройка весов scoring

```typescript
import { newsScoreService } from './ai/NewsScoreService';

// Обновление весов scoring системы
newsScoreService.updateWeights({
  aiWeight: 0.6,        // Больше веса на ИИ анализ
  contentWeight: 0.2,   // Меньше веса на контент
  sourceWeight: 0.15,   // Вес источника
  timelinessWeight: 0.05 // Меньше веса на актуальность
});
```

## Категории новостей

1. **политика** - политические события, решения власти
2. **экономика** - экономические новости, финансы
3. **технологии** - IT, научные открытия
4. **наука** - исследования, открытия
5. **спорт** - спортивные события
6. **культура** - культурные события, искусство
7. **медицина** - здравоохранение, медицинские новости
8. **происшествия** - ЧП, криминальные события
9. **международные новости** - зарубежные события
10. **общество** - социальные вопросы
11. **криптовалюты** - блокчейн, цифровые валюты
12. **финансы** - банки, инвестиции, рынки
13. **образование** - образовательные новости
14. **экология** - экологические вопросы
15. **другое** - прочие темы

## Тестирование

### Запуск тестов ИИ анализа

```bash
# Тестирование с образцами сообщений
npm run ai:test

# Unit тесты
npm test tests/ai/
npm test tests/services/AIProcessorService.test.ts
```

### Ручное тестирование

```typescript
import { aiProcessorService } from './services/AIProcessorService';

// Обработка всех необработанных сообщений
const stats = await aiProcessorService.processAllUnprocessedMessages();
console.log(`Обработано: ${stats.successful}/${stats.processed}`);

// Статистика
const processingStats = await aiProcessorService.getProcessingStats();
console.log(`Необработано: ${processingStats.unprocessed}`);
```

## Мониторинг и отладка

### Логирование

Все компоненты ИИ анализа используют структурированное логирование:

```typescript
// Уровни логов
DEBUG: детальная информация об анализе
INFO: общая информация о процессе
WARN: предупреждения (fallback режим)
ERROR: ошибки анализа
```

### Метрики

- Количество обработанных сообщений
- Средний балл важности
- Частота использования fallback режима
- Время обработки пакетов
- Распределение по категориям

## Fallback режим

При недоступности OpenAI API система автоматически переключается на fallback анализ:

- Эвристическая оценка важности по ключевым словам
- Базовая категоризация
- Простое извлечение ключевых слов
- Сохранение работоспособности системы

## Производительность

### Рекомендации по оптимизации

1. **Пакетная обработка** - обрабатывайте сообщения пакетами по 50-100 штук
2. **Кэширование** - рассмотрите кэширование результатов для похожих сообщений
3. **Приоритизация** - обрабатывайте критические сообщения в первую очередь
4. **Мониторинг лимитов** - следите за лимитами OpenAI API

### Настройки производительности

```typescript
const aiProcessor = new AIProcessorService({
  batchSize: 50,              // Размер пакета
  delayBetweenBatches: 2000,  // Задержка между пакетами (мс)
  enableFallback: true,       // Включить fallback
  minContentLength: 10,       // Минимальная длина для анализа
  skipIfProcessed: true       // Пропускать обработанные
});
```

## Безопасность

- API ключи хранятся в переменных окружения
- Никогда не логируются чувствительные данные
- Валидация всех входных данных
- Обработка ошибок без раскрытия внутренней логики